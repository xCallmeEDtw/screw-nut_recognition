
# 組合語言與微處理機實驗期末專題
# 螺帽螺絲自動分類與紀錄暨異物警示系統
#### 第十七組：B123040003 張景旭 / B113040009 羅妤暄

展示影片
https://www.youtube.com/watch?v=OAQxWPdW-yk

## 摘要
此專題使用LED燈元件、按鈕元件、ESP32-S3-WROOM CAM、ESP32、EV3與履帶組、自己撰寫之影像辨識程式、arduino IDE、ThingSpeak、Line notify，實踐一個螺帽螺絲自動分類與紀錄暨異物警示系統。
(一) 透過按鈕啟動與重置裝置。
(二) 透過ESP32-S3-WROOM CAM攝像頭，將擷取之影像傳送至伺服器，透過影像辨識程式判斷辨識物之種類。
(1) 辨識物為螺帽：將”螺帽’資料上傳ThingSpeak平台，並將辨識物透過EV3與履帶組傳送至螺帽區域。
(2) 辨識物為螺絲：將”螺絲”資料上傳至ThingSpeak平台，並將辨識物透過EV3與履帶組傳送至螺絲區域。
(3) 辨識物並非螺帽或螺絲任一：將”未知”資料上傳至ThingSpeak平台，將辨識物停留在原地，並利用Line notify系統傳送個人化警示。
(三) 透過LED燈顯示現在的運行狀態。
(1) 綠燈：任務均已執行完成。
(2) 黃燈：任務運作中。
(3) 紅燈：出現錯誤，需人工排除。


## 使用零件
LED燈元件、按鈕元件、ESP32-S3-WROOM CAM、ESP32、EV3與履帶組。
二組成部件
1.	攝像頭與履帶組
![ss1](https://hackmd.io/_uploads/Bymjg6sLee.png)
2.	操控部分 (Button和LED)
![ss2](https://hackmd.io/_uploads/Bk6wxasLle.jpg)


三、物聯網技術
![ss3](https://hackmd.io/_uploads/H1e1-6oLxl.png)


伺服器連接方式：ESP32會設立自己的ip adress。透過request，可以存取照片與得知按鈕啟動狀態。透過socket，方便與EV3直接message，傳送下達命令。
1.	Server透過request確認按鈕是否被按下
2.	Server request ESP32流程開始，LED變成黃色
3.	Server request ESP32-CAM得到照片
4.	Server處理照片分辨螺絲螺帽
5.	Server透過socket通知運輸帶往左或右送
6.	Server上傳紀錄至ThingSpeak紀錄
7.	Server request ESP32流程結束，LED變回綠色等待下次按下按鈕
 
## 影像處理過程
影像辨識各階段產生之圖檔：
![i1](https://hackmd.io/_uploads/rJVL-pjUxe.png)     
影像處理流程之內容簡述：
1.	將Original Image變成Thresh Image。 
![image](https://hackmd.io/_uploads/rJaYWajLge.png)

2.	將Thresh Image進行Dilate and Enrode。 
![image](https://hackmd.io/_uploads/Hy1s-psIll.png)

3.	利用處理出的圖片，找出Center Part。
![image](https://hackmd.io/_uploads/B1th-TjLxg.png)
        
4.	利用Center Part找出Contour。
![image](https://hackmd.io/_uploads/rJjGzTjIgl.png)
         
## 影像辨識方式
1.	透過處理出的Contour，判斷其roundness (圓度) 以分辨螺絲螺。
$roundnes = Perimeter2 / 4π × Area$ 
由於螺帽的形狀近似圓形，所以圓度會較螺絲大。以此做為判斷螺帽與螺絲的依據。
2.	透過影像面積，排除太大的物體，將其判定為異物。
3.	
## 製作問題與解決方法

### 影像判別正確率的強化
由於此系統仰賴影像辨識之結果進行後續所有的操作，影像辨識的準確率變至關重要。
	初版的影像辨識程式執行結果中，可發現影像可能因為辨識物不在畫面正中間，導致系統將雜訊區域判別為辨識物，進而造成判斷結果失準。
	故為了解決這項問題，在影像處理的細部流程增加比較判斷區域大小的步驟。將判斷區域的大小與螺絲螺帽的體積大小作比較，如果區域過小，則直接忽略此判斷區域，檢測下一個判斷區域。
此作法有效減低系統的誤判機率。
###	環境光線影響判斷結果
測試階段發現，若環境光線不足，影像辨識系統的雜質會增加，系統有機會無法正確分辨出螺絲與螺帽之區域，導致判斷結果失準。
經過測試，發現在辨識區域增加足夠之人工照明，便能有效解決問題。若在測試階段或成品驗收demo階段，發現系統辨識正確率不高，將增加人工照明於辨識區域上。
###	履帶的高低差造成判斷物彈跳移位
辨識區域的履帶與傳送區域的履帶為在不同的區域。影像辨識完畢後，須確保辨識物正確從輸送履帶被傳送到辨識履帶上。
測試階段發現，由於傳送區域的履帶與辨識區域的履帶之間存在高低差，辨識物有機會在轉換區域的過程中，脫離原本的軌道彈跳到系統外。
量測後製作相對應的底座、固定架，並在履帶上以元件分隔出辨識區域，避免量測物彈出的問題。另外使履帶在每次操作後自動回覆初始位置。減少操作時的變數。



## 最後成果
操作流程說明：
1.	LED燈顯示綠燈。
2.	將辨識物放至輸送履帶上，按下按鈕。
3.	LED燈顯示黃燈。辨識物由履帶送至辨識區域。
4.	ESP32-S3-WROOM CAM 擷取辨識物之即時影像。
5.	將擷取之影像傳送至伺服器，進行辨識物之類別判斷。
6.	根據判斷之結果進行對應之處理：
判斷類別為螺絲或螺帽：
(1)	輸送帶根據判斷之類別，將辨識物送至指定區域。
(2)	將辨識物類別資料上傳至ThingSpeak平台。
(3)	執行完成，LED燈轉為綠燈。
判斷類別為異物：
(1)	將“未知”資料上傳至ThingSpeak平台。
(2)	透過Line notify傳送異物警示。
(3)	LED燈轉換為紅燈，直到人工排除異常並按下按鈕，回復為綠燈。
7.	回到流程1，重複執行。
此作品可應用於螺帽螺絲生產工廠的流水線上。以自動化的方式，進行螺帽螺絲之辨識與實體分類；將辨識物之種類紀錄至雲端，並在雲端自行進行資料的統計與分析；在偵測到異物時，利用Line notify提出異物警示。實現自動化的螺帽螺絲自動分類與紀錄暨異物警示系統。
